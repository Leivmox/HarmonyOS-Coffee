import { promptAction, router } from '@kit.ArkUI';
import { confirmReceive, findOrder, removeOrder } from '../api/api';
import { getStorage } from '../utils/storage';

// 1. å®šä¹‰æ•°æ®æ¥å£ (ä¿æŒä¹‹å‰çš„ä¿®å¤é€»è¾‘)
interface OrderProduct {
  pid: string;
  name: string;
  rule: string;
  small_img: string;
  price: number | string;
  count: number;
  enname?: string;
}

interface OrderItem {
  oid: string;
  status: number;
  createdAt: string;
  count: number;
  total: string;
  products: OrderProduct[];
}

@Entry
@Component
struct MyOrders {
  // å…¨å±€ Token
  @StorageLink('token') token: string = '';
  // çŠ¶æ€ç®¡ç†
  @State currentStatus: number = 0;
  @State orderList: OrderItem[] = [];
  @State isLoading: boolean = false;
  // Tab èœå•
  private tabs: string[] = ['å…¨éƒ¨', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'];

  // =======================================================
  // ç”Ÿå‘½å‘¨æœŸ
  // =======================================================
  async aboutToAppear() {
    let context = getContext(this);
    try {
      let localToken = await getStorage("user_token", context);
      if (localToken) {
        this.token = localToken.toString();
        AppStorage.setOrCreate('token', this.token);
      }
    } catch (e) {
    }

    if (this.token) {
      this.getOrderList();
    } else {
      setTimeout(() => {
        if (!this.token) {
          promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
        }
      }, 500);
    }
  }

  // =======================================================
  // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (ä¿æŒä¹‹å‰çš„æ‰å¹³åŒ–æ•°æ®ä¿®å¤)
  // =======================================================
  // =======================================================
  // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (å·²ä¿®å¤ï¼šæŒ‰ OID åˆå¹¶è®¢å•)
  // =======================================================
  async getOrderList() {
    if (!this.token) {
      return;
    }
    this.isLoading = true;

    try {
      let res = await findOrder(this.token, this.currentStatus);

      let resData: Record<string, Object>;
      if (typeof res.result === 'string') {
        resData = JSON.parse(res.result);
      } else {
        resData = res.result as Record<string, Object>;
      }

      let list: Array<Record<string, Object>> = [];
      // å…¼å®¹å„ç§åç«¯è¿”å›æ ¼å¼
      if (Array.isArray(resData.result)) {
        list = resData.result as Array<Record<string, Object>>;
      } else if (Array.isArray(resData.data)) {
        list = resData.data as Array<Record<string, Object>>;
      } else if (Array.isArray(resData.orderList)) {
        list = resData.orderList as Array<Record<string, Object>>;
      }

      // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤å¼€å§‹ï¼šä½¿ç”¨ Map è¿›è¡Œåˆ†ç»„ ğŸ”¥ğŸ”¥ğŸ”¥
      let orderMap = new Map<string, OrderItem>();

      list.forEach((item: Record<string, Object>) => {
        let oid = (item.oid || item.id || '').toString();

        // 1. è§£æå½“å‰è¡Œçš„å•†å“ä¿¡æ¯
        let priceStr = (item.price || '0').toString();
        let countVal = (item.count as number) || 1;
        // å•ä¸ªå•†å“çš„æ€»ä»·
        let lineTotal = parseFloat(priceStr) * countVal;

        let product: OrderProduct = {
          pid: (item.pid || item.id || '').toString(),
          name: (item.name || 'æœªçŸ¥å•†å“').toString(),
          rule: (item.rule || '').toString(),
          small_img: (item.smallImg || item.small_img || '').toString(),
          price: priceStr,
          count: countVal,
          enname: (item.enname || '').toString()
        };

        // 2. åˆ¤æ–­è¿™ä¸ªè®¢å•IDæ˜¯å¦å·²ç»åœ¨ Map ä¸­å­˜åœ¨
        if (orderMap.has(oid)) {
          // A. å¦‚æœå·²å­˜åœ¨ï¼Œå–å‡ºæ—§è®¢å•ï¼ŒæŠŠå•†å“ push è¿›å»ï¼Œå¹¶ç´¯åŠ æ€»ä»·å’Œæ€»æ•°
          let existingOrder = orderMap.get(oid)!;
          existingOrder.products.push(product);
          existingOrder.count += countVal;

          // ç´¯åŠ é‡‘é¢ (å…ˆè½¬æ•°å­—ç›¸åŠ ï¼Œæœ€åç»Ÿä¸€è½¬å­—ç¬¦ä¸²)
          let currentTotal = parseFloat(existingOrder.total) + lineTotal;
          existingOrder.total = currentTotal.toFixed(2);

        } else {
          // B. å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„è®¢å•å¯¹è±¡
          let newOrder: OrderItem = {
            oid: oid,
            status: item.status as number,
            createdAt: (item.createdAt || '').toString(),
            count: countVal,
            total: lineTotal.toFixed(2), // åˆå§‹é‡‘é¢
            products: [product] // åˆå§‹åŒ–æ•°ç»„ï¼Œæ”¾å…¥ç¬¬ä¸€ä¸ªå•†å“
          };
          orderMap.set(oid, newOrder);
        }
      });

      // 3. å°† Map è½¬å›æ•°ç»„
      this.orderList = Array.from(orderMap.values());
      // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ç»“æŸ ğŸ”¥ğŸ”¥ğŸ”¥

    } catch (err) {
      promptAction.showToast({ message: 'æ•°æ®åŠ è½½å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  async handleConfirm(oid: string) {
    try {
      await confirmReceive(this.token, oid);
      promptAction.showToast({ message: 'å·²æ”¶è´§' });
      this.getOrderList();
    } catch (e) {
    }
  }

  async handleDelete(oid: string) {
    promptAction.showDialog({
      title: 'æç¤º',
      message: 'ç¡®å®šåˆ é™¤ï¼Ÿ',
      buttons: [{ text: 'å–æ¶ˆ', color: '#666' }, { text: 'åˆ é™¤', color: 'red' }]
    })
      .then(async (resp) => {
        if (resp.index === 1) {
          await removeOrder(this.token, oid);
          this.getOrderList();
        }
      })
  }

  // =======================================================
  // UI æ„å»º
  // =======================================================

  @Builder
  OrderCard(item: OrderItem) {
    Column() {
      // 1. æ ‡é¢˜ "è®¢å•ä¿¡æ¯"
      Text("è®¢å•ä¿¡æ¯")
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')
        .width('100%')
        .margin({ bottom: 10 })

      // 2. å¤´éƒ¨ (è®¢å•å· & çŠ¶æ€)
      Row() {
        Text(`è®¢å•ç¼–å·: ${item.oid}`).fontSize(13).fontColor('#999').layoutWeight(1)
        if (item.status === 1) {
          Text("ç¡®è®¤æ”¶è´§")
            .fontSize(13)
            .fontColor('#0C34BA')
            .fontWeight(FontWeight.Medium)
            .onClick(() => this.handleConfirm(item.oid))
        } else if (item.status === 2) {
          Row() {
            Text("å·²å®Œæˆ")
              .fontSize(14)
              .fontColor('#666')
              .margin({ right: 10 })
            Image($r('app.media.del'))
              .width(16)
              .height(16)
              .onClick(() => this.handleDelete(item.oid))
          }
        }
      }
      .width("100%").justifyContent(FlexAlign.SpaceBetween).padding({ bottom: 15 })

      // 3. å•†å“åˆ—è¡¨ (è¿™é‡Œä¹‹å‰æœ‰ä¸¤å±‚ ForEachï¼Œç°åœ¨åªä¿ç•™ä¸€å±‚)
      Column() {
        // ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®å¤ç‚¹ï¼šåªä¿ç•™è¿™ä¸€å±‚ ForEach ğŸ”¥ğŸ”¥ğŸ”¥
        ForEach(item.products, (prod: OrderProduct) => {
          Row() {
            // å·¦ä¾§å›¾ç‰‡
            Image(prod.small_img)
              .width(60)
              .height(60)
              .borderRadius(4)
              .backgroundColor('#f5f5f5')
              .objectFit(ImageFit.Cover)

            // å³ä¾§ä¿¡æ¯åŒºåŸŸ
            Column({ space: 5 }) {
              // ç¬¬ä¸€è¡Œï¼šåç§° + è§„æ ¼
              Row() {
                Text(prod.name)
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#333')
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })

                Text(prod.rule)
                  .fontSize(12)
                  .fontColor('#999')
                  .maxLines(1)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .margin({ left: 10 })
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
              .alignItems(VerticalAlign.Bottom)

              // ç¬¬äºŒè¡Œï¼šè‹±æ–‡å
              Text(prod.enname)
                .fontSize(12)
                .fontColor('#999')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .width('100%')

              // ç¬¬ä¸‰è¡Œï¼šä»·æ ¼ + æ•°é‡
              Row() {
                Text(`ï¿¥${prod.price}`)
                  .fontSize(14)
                  .fontColor('#E60012')
                  .fontWeight(FontWeight.Bold)
                  .layoutWeight(1)

                Text(`x${prod.count}`)
                  .fontSize(12)
                  .fontColor('#999')
              }
              .width('100%')
              .justifyContent(FlexAlign.SpaceBetween)
            }
            .layoutWeight(1)
            .padding({ left: 10 })
            .height(60)
            .justifyContent(FlexAlign.SpaceBetween)

          }
          .width("100%")
          .margin({ bottom: 15 })
        })
      }
      .width("100%")

      // 4. åˆ†å‰²çº¿
      Divider().color('#f5f5f5').strokeWidth(1).margin({ bottom: 10 })

      // 5. åº•éƒ¨ä¿¡æ¯ (æ—¶é—´ & æ€»ä»·)
      Text(item.createdAt.replace('T', ' ').substring(0, 19))
        .fontSize(13).fontColor('#454545').width('100%').margin({ bottom: 8 })

      Row() {
        Text(`å…±è®¡ ${item.count} ä»¶å•†å“`).fontSize(13).fontColor('#666')
        Row() {
          Text("è®¢å•é‡‘é¢: ").fontSize(16).fontColor('#E60012').fontWeight(FontWeight.Bold)
          Text(`ï¿¥${item.total}`).fontSize(16).fontColor('#E60012').fontWeight(FontWeight.Bold)
        }
      }
      .width("100%")
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width("95%")
    .backgroundColor(Color.White)
    .borderRadius(12) // ç»Ÿä¸€åœ†è§’
    .padding(15)
    .margin({ bottom: 15 })
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨æ ‡é¢˜æ  (å›ºå®š)
      Row() {
        Row() {
          Text("< è¿”å›").fontColor('#0C34BA').fontSize(16)
        }
        .height('100%').onClick(() => {
          router.back()
        }).padding({ left: 15 })

        Text("æˆ‘çš„è®¢å•")
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .padding({ right: 60 })
      }
      .width("100%").height(56).backgroundColor(Color.White).zIndex(99)

      // 2. Stack å¸ƒå±€ (æ¨¡ä»¿ PersonalInfo)
      Stack({ alignContent: Alignment.Top }) {

        // å±‚çº§1ï¼šè“è‰²èƒŒæ™¯æ¡
        Column().width('100%').height(130).backgroundColor('#0C34BA')

        // å±‚çº§2ï¼šä¸»è¦å†…å®¹åŒºåŸŸ
        Column() {

          // (1) Tabs å¡ç‰‡ - å°±åƒ PersonalInfo çš„ç™½è‰²å¡ç‰‡ä¸€æ ·æ‚¬æµ®
          Row() {
            ForEach(this.tabs, (item: string, index: number) => {
              Column() {
                Text(item)
                  .fontSize(15)
                  .fontWeight(this.currentStatus === index ? FontWeight.Bold : FontWeight.Normal)
                  .fontColor(this.currentStatus === index ? '#0C34BA' : '#666')
                  .margin({ bottom: 8 })
                // è“è‰²æŒ‡ç¤ºæ¡
                if (this.currentStatus === index) {
                  Row().width(25).height(3).backgroundColor('#0C34BA').borderRadius(2)
                } else {
                  Row().width(25).height(3).backgroundColor(Color.Transparent)
                }
              }
              .layoutWeight(1).justifyContent(FlexAlign.Center).height("100%")
              .onClick(() => {
                this.currentStatus = index;
                this.getOrderList();
              })
            })
          }
          .width('95%') // å®½åº¦ä¸ PersonalInfo ä¸€è‡´
          .height(60) // Tab é«˜åº¦
          .backgroundColor(Color.White)
          .borderRadius({
            topLeft: 12,
            topRight: 12,
            bottomLeft: 0,
            bottomRight: 0
          }) // åœ†è§’ä¸€è‡´
          .margin({ top: 90 }) // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ï¼šè·ç¦»é¡¶éƒ¨ 90ï¼Œäº§ç”Ÿæ‚¬æµ®æ•ˆæœ
          // .shadow({ radius: 10, color: 'rgba(0,0,0,0.1)', offsetY: 5 })

          // (2) è®¢å•åˆ—è¡¨åŒºåŸŸ
          if (this.isLoading && this.orderList.length === 0) {
            Text("åŠ è½½ä¸­...").fontColor('#999').margin({ top: 40 })
          } else if (this.orderList.length === 0) {
            Column() {
              Image($r('app.media.Null')).width(80).height(80).opacity(0.5).margin({ bottom: 10 })
              Text("æš‚æ— è®¢å•").fontColor('#999')
            }.width('100%').height(200).justifyContent(FlexAlign.Center)
          } else {
            List() {
              ForEach(this.orderList, (item: OrderItem) => {
                ListItem() {
                  this.OrderCard(item)
                }
              })
            }
            .width("100%")
            .layoutWeight(1) // å æ®å‰©ä½™ç©ºé—´
            .margin({ top: 15 }) // åˆ—è¡¨å’Œ Tab çš„é—´è·
            .scrollBar(BarState.Off)
            .alignListItem(ListItemAlign.Center) // è®©åˆ—è¡¨é¡¹å±…ä¸­
          }

        }
        .width('100%')
        .height('100%') // å†…å®¹å±‚æ’‘æ»¡
      }
      .layoutWeight(1)
      .backgroundColor('#F5F5F5') // ğŸ”¥ åº•å±‚èƒŒæ™¯è‰²æ”¹ä¸ºæµ…ç°
    }
    .width("100%").height("100%")
  }
}
