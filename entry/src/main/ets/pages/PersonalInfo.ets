import { promptAction, router } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';
import { http } from '@kit.NetworkKit';
import { ApiResponse, findAccountInfo, updateDesc, updateNickName, UserInfo } from '../api/api';
import { getStorage } from '../utils/storage';

/**
 * ‰∏™‰∫∫ËµÑÊñôÈ°µÈù¢
 *
 * @author Leivmox
 */

@Entry
@Component
struct PersonalInfo {
  // 1. Ëé∑ÂèñÂÖ®Â±Ä Token
  @StorageLink('token') token: string = '';
  // 2. È°µÈù¢ÊòæÁ§∫Áä∂ÊÄÅ
  @State userId: string = 'ËØªÂèñ‰∏≠...';
  @State phone: string = 'ËØªÂèñ‰∏≠...';
  @State nickName: string = 'Âä†ËΩΩ‰∏≠...';
  @State intro: string = 'Âä†ËΩΩ‰∏≠...';
  // 3. ÂºπÁ™ó(Sheet)ÊéßÂà∂Áä∂ÊÄÅ
  @State isShowSheet: boolean = false;
  @State editType: string = ''; // 'nickname' Êàñ 'intro'
  @State sheetTitle: string = ''; // ÂºπÁ™óÊ†áÈ¢ò
  @State inputValue: string = ''; // ËæìÂÖ•Ê°ÜÁöÑÂÄº

  // ÁîüÂëΩÂë®Êúü‰∏éÂàùÂßãÂåñ
  aboutToAppear() {
    this.initData();
  }

  async initData() {
    let context = getContext(this);

    // 1. ÂÖàËØªÊú¨Âú∞ÁºìÂ≠ò
    try {
      let savedPhone = await getStorage("user_phone", context);
      let savedId = await getStorage("user_id", context);
      this.phone = savedPhone ? savedPhone.toString() : 'Êú™ÁªëÂÆö';
      this.userId = savedId ? savedId.toString() : 'Êú™ÁôªÂΩï';
    } catch (e) {
    }

    // 2. Ëé∑Âèñ Token
    let finalToken = this.token;
    if (!finalToken) {
      let localToken = await getStorage("user_token", context);
      if (localToken) {
        finalToken = localToken.toString();
        this.token = finalToken;
      }
    }

    if (!finalToken) {
      this.nickName = "Êú™ÁôªÂΩï";
      this.intro = "ËØ∑ÂÖàÁôªÂΩï";
      return;
    }

    // 3. ËØ∑Ê±ÇÊúÄÊñ∞Êé•Âè£Êï∞ÊçÆ
    findAccountInfo(finalToken).then((res) => {
      let resData: ApiResponse<UserInfo[] | UserInfo>;
      // ÂÖºÂÆπ JSON Â≠óÁ¨¶‰∏≤ÊàñÂØπË±°
      if (typeof res.result === 'string') {
        resData = JSON.parse(res.result) as ApiResponse<UserInfo[] | UserInfo>;
      } else {
        resData = res.result as ApiResponse<UserInfo[] | UserInfo>;
      }

      // ÂÆΩÊùæÂà§Êñ≠Áä∂ÊÄÅÁ†Å
      const codeStr = String(resData.code);
      if (['200', 'B001', 'A001', '0', '1'].includes(codeStr)) {
        let user: UserInfo | null = null;
        if (Array.isArray(resData.result)) {
          if (resData.result.length > 0) {
            user = resData.result[0];
          }
        } else {
          user = resData.result as UserInfo;
        }

        if (user) {
          this.nickName = user.nickName || 'Êú™ËÆæÁΩÆ';
          this.intro = user.desc || 'ÊöÇÊó†ÁÆÄ‰ªã';
          if (user.userId) {
            this.userId = user.userId;
          }
          if (user.phone) {
            this.phone = user.phone;
          }
        }
      }
    }).catch((err: BusinessError) => {
      console.error("PersonalInfo: ËØ∑Ê±ÇÂºÇÂ∏∏", JSON.stringify(err));
    })
  }

  //  --- ‰øùÂ≠òÈÄªËæë ---
  saveInfo() {
    console.info(`[Debug] ÁÇπÂáª‰øùÂ≠ò: type=${this.editType}, value=${this.inputValue}`);

    // 1. Ê†°È™åÁ©∫ÂÄº
    if (this.inputValue.trim() === '') {
      promptAction.showToast({ message: 'ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫' });
      return;
    }

    // 2. ÂÆö‰πâÊàêÂäüÂêéÁöÑÂõûË∞É
    const handleSuccess = () => {
      console.info('[Debug] ‰øÆÊîπÊàêÂäüÔºåÂºÄÂßãÊõ¥Êñ∞UI');

      // A. ÂÖ≥Èó≠ÂºπÁ™ó
      this.isShowSheet = false;

      // B. Á´ãÂç≥Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫ÁöÑÂèòÈáè
      if (this.editType === 'nickname') {
        this.nickName = this.inputValue;
      } else if (this.editType === 'intro') {
        // üî• ‰πãÂâçËøôÈáåÂèØËÉΩÊºè‰∫ÜÔºåÁé∞Âú®ÊòéÁ°ÆËµãÂÄº
        this.intro = this.inputValue;
      }

      // C. ÊèêÁ§∫‰∏éÈÄöÁü•
      promptAction.showToast({ message: '‰øÆÊîπÊàêÂäü' });
      // ÈÄöÁü• My È°µÈù¢Âà∑Êñ∞
      AppStorage.setOrCreate('userInfoUpdated', Date.now());
    };

    // 3. ÂÆö‰πâÊé•Âè£ÂìçÂ∫îÂ§ÑÁêÜ
    const handleResponse = (res: http.HttpResponse) => {
      console.info('[Debug] Êé•Âè£ËøîÂõû:', JSON.stringify(res));
      try {
        let resData: ApiResponse;
        if (typeof res.result === 'string') {
          resData = JSON.parse(res.result);
        } else {
          resData = res.result as ApiResponse;
        }

        const codeStr = String(resData.code);

        if (['200', 'B001', 'A001', 'C001', '0', '1'].includes(codeStr)) {
          handleSuccess();
        } else {
          if (resData.msg && resData.msg.includes('ÊàêÂäü')) {
            handleSuccess();
          } else {
            console.warn('[Debug] ‰∏öÂä°Â§±Ë¥• code:', codeStr);
            promptAction.showToast({ message: resData.msg || '‰øÆÊîπÂ§±Ë¥•' });
          }
        }
      } catch (e) {
        console.error('[Debug] Ëß£ÊûêÂºÇÂ∏∏:', JSON.stringify(e));
        promptAction.showToast({ message: 'Êï∞ÊçÆËß£ÊûêÈîôËØØ' });
      }
    };

    // 4. Ê†πÊçÆÁ±ªÂûãË∞ÉÁî®‰∏çÂêåÊé•Âè£
    if (this.editType === 'nickname') {
      updateNickName(this.token, this.inputValue)
        .then(handleResponse)
        .catch((err: BusinessError) => {
          console.error('[Debug] ÁΩëÁªúÈîôËØØ:', JSON.stringify(err));
          promptAction.showToast({ message: 'ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•' });
        });
    } else if (this.editType === 'intro') {
      updateDesc(this.token, this.inputValue)
        .then(handleResponse)
        .catch((err: BusinessError) => {
          console.error('[Debug] ÁΩëÁªúÈîôËØØ:', JSON.stringify(err));
          promptAction.showToast({ message: 'ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•' });
        });
    }
  }

  // ÂºπÁ™ó‰∏é UI ÊûÑÂª∫
  openEditSheet(type: string) {
    this.editType = type;
    this.isShowSheet = true;

    if (type === 'nickname') {
      this.sheetTitle = "‰øÆÊîπÊòµÁß∞";
      // Â¶ÇÊûúÊòØÈªòËÆ§ÊñáÊ°àÔºåÊ∏ÖÁ©∫ËæìÂÖ•Ê°ÜÊñπ‰æøÁî®Êà∑ËæìÂÖ•
      this.inputValue = (this.nickName === 'Êú™ËÆæÁΩÆ' || this.nickName === 'Âä†ËΩΩ‰∏≠...') ? '' : this.nickName;
    } else if (type === 'intro') {
      this.sheetTitle = "‰øÆÊîπ‰∏™‰∫∫ÁÆÄ‰ªã";
      this.inputValue = (this.intro === 'ÊöÇÊó†ÁÆÄ‰ªã' || this.intro === 'Âä†ËΩΩ‰∏≠...') ? '' : this.intro;
    }
  }

  // ÂºπÁ™óÂÜÖÂÆπÊûÑÂª∫Âô®
  @Builder
  EditSheetBuilder() {
    Column() {
      // È°∂ÈÉ®Ê†èÔºöÊ†áÈ¢ò + ÂèñÊ∂à
      Row() {
        Text(this.sheetTitle).fontSize(18).fontWeight(FontWeight.Bold)
        Text("ÂèñÊ∂à").fontSize(16).fontColor('#999')
          .onClick(() => {
            this.isShowSheet = false
          })
      }
      .width("100%").justifyContent(FlexAlign.SpaceBetween).padding({ bottom: 20 })

      // ËæìÂÖ•Âå∫Âüü
      if (this.editType === 'nickname') {
        TextInput({ text: this.inputValue, placeholder: 'ËØ∑ËæìÂÖ•Êñ∞ÊòµÁß∞' })
          .height(50).backgroundColor('#F5F5F5').borderRadius(8)
          .onChange((val) => {
            this.inputValue = val
          })
      } else {
        TextArea({ text: this.inputValue, placeholder: 'ËØ∑ËæìÂÖ•‰∏™‰∫∫ÁÆÄ‰ªã' })
          .height(120).backgroundColor('#F5F5F5').borderRadius(8)
          .onChange((val) => {
            this.inputValue = val
          })
      }

      // ‰øùÂ≠òÊåâÈíÆ
      Button("‰øùÂ≠ò")
        .width("100%")
        .height(45)
        .margin({ top: 30 })
        .backgroundColor('#0C34BA')
        .onClick(() => {
          this.saveInfo()
        })
    }
    .width('100%').height('100%').padding(20).backgroundColor(Color.White)
  }

  build() {
    Column() {
      // 1. È°∂ÈÉ®Ê†áÈ¢òÊ†è
      Row() {
        Row() {
          Text("< ËøîÂõû").fontColor('#0C34BA').fontSize(16)
        }
        .height('100%').onClick(() => {
          router.back()
        }).padding({ left: 15 })

        Text("‰∏™‰∫∫ËµÑÊñô")
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .padding({ right: 60 })
      }
      .width("100%").height(56).backgroundColor(Color.White).zIndex(2)

      Stack({ alignContent: Alignment.Top }) {
        // ËìùËâ≤ËÉåÊôØ
        Column().width('100%').height(130).backgroundColor('#0C34BA')

        // ÁôΩËâ≤Âç°Áâá
        Column() {
          Column() {
            // --- Â§¥ÂÉè ---
            Row() {
              Text("Â§¥ÂÉè").fontSize(15).fontColor('#333')
              Image($r('app.media.avator1'))
                .width(50)
                .height(50)
                .borderRadius(25)
                .objectFit(ImageFit.Cover)
                .backgroundColor('#eee')
            }
            .width('100%').justifyContent(FlexAlign.SpaceBetween)
            .padding({ top: 10, bottom: 10 })

            Divider().color('#F5F5F5').strokeWidth(1)

            // --- ID ---
            Row() {
              Text("Áî®Êà∑ID").fontSize(15).fontColor('#333')
              Text(this.userId).fontSize(14).fontColor('#999')
            }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding({ top: 20, bottom: 20 })

            Divider().color('#F5F5F5').strokeWidth(1)

            // --- ÊâãÊú∫Âè∑ ---
            Row() {
              Text("ÊâãÊú∫Âè∑").fontSize(15).fontColor('#333')
              Text(this.phone).fontSize(14).fontColor('#999')
            }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding({ top: 20, bottom: 20 })

            Divider().color('#F5F5F5').strokeWidth(1)

            // --- ÊòµÁß∞ (ÂèØÁÇπ) ---
            Row() {
              Text("ÊòµÁß∞").fontSize(15).fontColor('#333')
              Row() {
                Text(this.nickName).fontSize(14).fontColor('#666')
                Text(" >").fontSize(14).fontColor('#ccc')
              }
            }
            .width('100%').justifyContent(FlexAlign.SpaceBetween)
            .padding({ top: 20, bottom: 20 })
            .onClick(() => {
              this.openEditSheet('nickname')
            })

            Divider().color('#F5F5F5').strokeWidth(1)

            // --- ÁÆÄ‰ªã  ---
            Column({ space: 10 }) {
              Row() {
                Text("ÁÆÄ‰ªã").fontSize(15).fontColor('#333')
                Text(" >").fontSize(14).fontColor('#ccc')
              }.width('100%').justifyContent(FlexAlign.SpaceBetween)

              Text(this.intro)
                .fontSize(14).fontColor('#999')
                .width('100%').lineHeight(20)
            }
            .width('100%').padding({ top: 20, bottom: 20 })
            .onClick(() => {
              this.openEditSheet('intro')
            })
          }
          .width('100%')
        }
        .width('95%')
        .backgroundColor(Color.White)
        .borderRadius(12)
        .padding({
          left: 15,
          right: 15,
          top: 5,
          bottom: 20
        })
        .margin({ top: 90, bottom: 20 })
      }
      .layoutWeight(1).backgroundColor('#F5F5F5')
    }
    .width('100%').height('100%')

    // ÁªëÂÆöÂçäÊ®°ÊÄÅ
    .bindSheet($$this.isShowSheet, this.EditSheetBuilder(), {
      height: 280,
      dragBar: true,
      backgroundColor: Color.White,
      showClose: false
    })
  }
}
