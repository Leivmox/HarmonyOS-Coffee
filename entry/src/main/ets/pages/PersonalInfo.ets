import { router, promptAction } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';
import { http } from '@kit.NetworkKit';
// ç¡®ä¿ä½ çš„ api æ–‡ä»¶é‡Œå¯¼å‡ºäº† updateDesc
import { findAccountInfo, updateNickName, updateDesc, ApiResponse, UserInfo } from '../api/api';
import { getStorage } from '../utils/storage';

@Entry
@Component
struct PersonalInfo {
  // 1. è·å–å…¨å±€ Token
  @StorageLink('token') token: string = '';

  // 2. é¡µé¢æ˜¾ç¤ºçŠ¶æ€
  @State userId: string = 'è¯»å–ä¸­...';
  @State phone: string = 'è¯»å–ä¸­...';
  @State nickName: string = 'åŠ è½½ä¸­...';
  @State intro: string = 'åŠ è½½ä¸­...';

  // 3. å¼¹çª—(Sheet)æ§åˆ¶çŠ¶æ€
  @State isShowSheet: boolean = false;
  @State editType: string = '';      // 'nickname' æˆ– 'intro'
  @State sheetTitle: string = '';    // å¼¹çª—æ ‡é¢˜
  @State inputValue: string = '';    // è¾“å…¥æ¡†çš„å€¼

  // =======================================================
  // ç”Ÿå‘½å‘¨æœŸä¸åˆå§‹åŒ–
  // =======================================================
  aboutToAppear() {
    this.initData();
  }

  async initData() {
    let context = getContext(this);

    // 1. å…ˆè¯»æœ¬åœ°ç¼“å­˜ (ä¸ºäº†è®©ç•Œé¢ä¸ç•™ç™½ï¼Œå…ˆæ˜¾ç¤ºæ—§æ•°æ®)
    try {
      let savedPhone = await getStorage("user_phone", context);
      let savedId = await getStorage("user_id", context);
      this.phone = savedPhone ? savedPhone.toString() : 'æœªç»‘å®š';
      this.userId = savedId ? savedId.toString() : 'æœªç™»å½•';
    } catch (e) {}

    // 2. è·å– Token (ä¼˜å…ˆå†…å­˜ï¼Œå…¶æ¬¡ç¼“å­˜)
    let finalToken = this.token;
    if (!finalToken) {
      let localToken = await getStorage("user_token", context);
      if (localToken) {
        finalToken = localToken.toString();
        this.token = finalToken;
      }
    }

    if (!finalToken) {
      this.nickName = "æœªç™»å½•";
      this.intro = "è¯·å…ˆç™»å½•";
      return;
    }

    // 3. è¯·æ±‚æœ€æ–°æ¥å£æ•°æ®
    findAccountInfo(finalToken).then((res) => {
      let resData: ApiResponse<UserInfo[] | UserInfo>;
      // å…¼å®¹ JSON å­—ç¬¦ä¸²æˆ–å¯¹è±¡
      if (typeof res.result === 'string') {
        resData = JSON.parse(res.result) as ApiResponse<UserInfo[] | UserInfo>;
      } else {
        resData = res.result as ApiResponse<UserInfo[] | UserInfo>;
      }

      // å®½æ¾åˆ¤æ–­çŠ¶æ€ç 
      const codeStr = String(resData.code);
      if (['200', 'B001', 'A001', '0', '1'].includes(codeStr)) {
        let user: UserInfo | null = null;
        if (Array.isArray(resData.result)) {
          if (resData.result.length > 0) user = resData.result[0];
        } else {
          user = resData.result as UserInfo;
        }

        if (user) {
          this.nickName = user.nickName || 'æœªè®¾ç½®';
          this.intro = user.desc || 'æš‚æ— ç®€ä»‹';
          if (user.userId) this.userId = user.userId;
          if (user.phone) this.phone = user.phone;
        }
      }
    }).catch((err: BusinessError) => {
      console.error("PersonalInfo: è¯·æ±‚å¼‚å¸¸", JSON.stringify(err));
    })
  }

  // =======================================================
  // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒï¼šä¿å­˜é€»è¾‘ (ä¿®å¤äº†ç®€ä»‹ä¸æ›´æ–°çš„é—®é¢˜)
  // =======================================================
  saveInfo() {
    console.info(`[Debug] ç‚¹å‡»ä¿å­˜: type=${this.editType}, value=${this.inputValue}`);

    // 1. æ ¡éªŒç©ºå€¼
    if (this.inputValue.trim() === '') {
      promptAction.showToast({ message: 'å†…å®¹ä¸èƒ½ä¸ºç©º' });
      return;
    }

    // 2. å®šä¹‰æˆåŠŸåçš„å›è°ƒ (å°è£…èµ·æ¥ï¼Œé¿å…ä»£ç é‡å¤)
    const handleSuccess = () => {
      console.info('[Debug] ä¿®æ”¹æˆåŠŸï¼Œå¼€å§‹æ›´æ–°UI');

      // A. å…³é—­å¼¹çª—
      this.isShowSheet = false;

      // B. ç«‹å³æ›´æ–°ç•Œé¢æ˜¾ç¤ºçš„å˜é‡
      if (this.editType === 'nickname') {
        this.nickName = this.inputValue;
      } else if (this.editType === 'intro') {
        // ğŸ”¥ ä¹‹å‰è¿™é‡Œå¯èƒ½æ¼äº†ï¼Œç°åœ¨æ˜ç¡®èµ‹å€¼
        this.intro = this.inputValue;
      }

      // C. æç¤ºä¸é€šçŸ¥
      promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸ' });
      // é€šçŸ¥ My é¡µé¢åˆ·æ–°
      AppStorage.setOrCreate('userInfoUpdated', Date.now());
    };

    // 3. å®šä¹‰æ¥å£å“åº”å¤„ç†
    const handleResponse = (res: http.HttpResponse) => {
      console.info('[Debug] æ¥å£è¿”å›:', JSON.stringify(res));
      try {
        let resData: ApiResponse;
        if (typeof res.result === 'string') {
          resData = JSON.parse(res.result);
        } else {
          resData = res.result as ApiResponse;
        }

        const codeStr = String(resData.code);

        // å®½æ¾åˆ¤æ–­ï¼šåŒ…å«ä½ é‡åˆ°çš„ C001
        if (['200', 'B001', 'A001', 'C001', '0', '1'].includes(codeStr)) {
          handleSuccess();
        } else {
          // æŸäº›æ¥å£è™½ç„¶ code ä¸å¯¹ï¼Œä½† msg è¯´æˆåŠŸäº†ï¼Œä¹Ÿç®—è¿‡
          if (resData.msg && resData.msg.includes('æˆåŠŸ')) {
            handleSuccess();
          } else {
            console.warn('[Debug] ä¸šåŠ¡å¤±è´¥ code:', codeStr);
            promptAction.showToast({ message: resData.msg || 'ä¿®æ”¹å¤±è´¥' });
          }
        }
      } catch (e) {
        console.error('[Debug] è§£æå¼‚å¸¸:', JSON.stringify(e));
        promptAction.showToast({ message: 'æ•°æ®è§£æé”™è¯¯' });
      }
    };

    // 4. æ ¹æ®ç±»å‹è°ƒç”¨ä¸åŒæ¥å£
    if (this.editType === 'nickname') {
      updateNickName(this.token, this.inputValue)
        .then(handleResponse)
        .catch((err: BusinessError) => {
          console.error('[Debug] ç½‘ç»œé”™è¯¯:', JSON.stringify(err));
          promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' });
        });
    }
    else if (this.editType === 'intro') {
      // ğŸ”¥ ç¡®ä¿è¿™é‡Œè°ƒç”¨çš„æ˜¯ updateDesc
      updateDesc(this.token, this.inputValue)
        .then(handleResponse)
        .catch((err: BusinessError) => {
          console.error('[Debug] ç½‘ç»œé”™è¯¯:', JSON.stringify(err));
          promptAction.showToast({ message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' });
        });
    }
  }

  // =======================================================
  // å¼¹çª—ä¸ UI æ„å»º
  // =======================================================

  openEditSheet(type: string) {
    this.editType = type;
    this.isShowSheet = true;

    if (type === 'nickname') {
      this.sheetTitle = "ä¿®æ”¹æ˜µç§°";
      // å¦‚æœæ˜¯é»˜è®¤æ–‡æ¡ˆï¼Œæ¸…ç©ºè¾“å…¥æ¡†æ–¹ä¾¿ç”¨æˆ·è¾“å…¥
      this.inputValue = (this.nickName === 'æœªè®¾ç½®' || this.nickName === 'åŠ è½½ä¸­...') ? '' : this.nickName;
    } else if (type === 'intro') {
      this.sheetTitle = "ä¿®æ”¹ä¸ªäººç®€ä»‹";
      this.inputValue = (this.intro === 'æš‚æ— ç®€ä»‹' || this.intro === 'åŠ è½½ä¸­...') ? '' : this.intro;
    }
  }

  // å¼¹çª—å†…å®¹æ„å»ºå™¨
  @Builder
  EditSheetBuilder() {
    Column() {
      // é¡¶éƒ¨æ ï¼šæ ‡é¢˜ + å–æ¶ˆ
      Row() {
        Text(this.sheetTitle).fontSize(18).fontWeight(FontWeight.Bold)
        Text("å–æ¶ˆ").fontSize(16).fontColor('#999')
          .onClick(() => { this.isShowSheet = false })
      }
      .width("100%").justifyContent(FlexAlign.SpaceBetween).padding({ bottom: 20 })

      // è¾“å…¥åŒºåŸŸ
      if (this.editType === 'nickname') {
        TextInput({ text: this.inputValue, placeholder: 'è¯·è¾“å…¥æ–°æ˜µç§°' })
          .height(50).backgroundColor('#F5F5F5').borderRadius(8)
          .onChange((val) => { this.inputValue = val })
      } else {
        TextArea({ text: this.inputValue, placeholder: 'è¯·è¾“å…¥ä¸ªäººç®€ä»‹' })
          .height(120).backgroundColor('#F5F5F5').borderRadius(8)
          .onChange((val) => { this.inputValue = val })
      }

      // ä¿å­˜æŒ‰é’®
      Button("ä¿å­˜").width("100%").height(45).margin({ top: 30 })
        .backgroundColor('#0C34BA')
        .onClick(() => { this.saveInfo() })
    }
    .width('100%').height('100%').padding(20).backgroundColor(Color.White)
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Row() { Text("< è¿”å›").fontColor('#0C34BA').fontSize(16) }
        .height('100%').onClick(() => { router.back() }).padding({ left: 15 })

        Text("ä¸ªäººèµ„æ–™").fontSize(18).fontWeight(FontWeight.Bold)
          .layoutWeight(1).textAlign(TextAlign.Center).padding({ right: 60 })
      }
      .width("100%").height(56).backgroundColor(Color.White).zIndex(2)

      Stack({ alignContent: Alignment.Top }) {
        // è“è‰²èƒŒæ™¯
        Column().width('100%').height(130).backgroundColor('#0C34BA')

        // ç™½è‰²å¡ç‰‡
        Column() {
          Column() {
            // --- å¤´åƒ ---
            Row() {
              Text("å¤´åƒ").fontSize(15).fontColor('#333')
              Image($r('app.media.avator1'))
                .width(50).height(50).borderRadius(25)
                .objectFit(ImageFit.Cover).backgroundColor('#eee')
            }
            .width('100%').justifyContent(FlexAlign.SpaceBetween)
            .padding({ top: 10, bottom: 10 })

            Divider().color('#F5F5F5').strokeWidth(1)

            // --- ID ---
            Row() {
              Text("ç”¨æˆ·ID").fontSize(15).fontColor('#333')
              Text(this.userId).fontSize(14).fontColor('#999')
            }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding({ top: 20, bottom: 20 })

            Divider().color('#F5F5F5').strokeWidth(1)

            // --- æ‰‹æœºå· ---
            Row() {
              Text("æ‰‹æœºå·").fontSize(15).fontColor('#333')
              Text(this.phone).fontSize(14).fontColor('#999')
            }.width('100%').justifyContent(FlexAlign.SpaceBetween).padding({ top: 20, bottom: 20 })

            Divider().color('#F5F5F5').strokeWidth(1)

            // --- æ˜µç§° (å¯ç‚¹) ---
            Row() {
              Text("æ˜µç§°").fontSize(15).fontColor('#333')
              Row() {
                Text(this.nickName).fontSize(14).fontColor('#666')
                Text(" >").fontSize(14).fontColor('#ccc')
              }
            }
            .width('100%').justifyContent(FlexAlign.SpaceBetween)
            .padding({ top: 20, bottom: 20 })
            .onClick(() => { this.openEditSheet('nickname') })

            Divider().color('#F5F5F5').strokeWidth(1)

            // --- ç®€ä»‹ (å¯ç‚¹) ---
            Column({ space: 10 }) {
              Row() {
                Text("ç®€ä»‹").fontSize(15).fontColor('#333')
                Text(" >").fontSize(14).fontColor('#ccc')
              }.width('100%').justifyContent(FlexAlign.SpaceBetween)

              Text(this.intro)
                .fontSize(14).fontColor('#999')
                .width('100%').lineHeight(20)
            }
            .width('100%').padding({ top: 20, bottom: 20 })
            .onClick(() => { this.openEditSheet('intro') })
          }
          .width('100%')
        }
        .width('95%').backgroundColor(Color.White).borderRadius(12)
        .padding({ left: 15, right: 15, top: 5, bottom: 20 })
        .margin({ top: 90, bottom: 20 })
      }
      .layoutWeight(1).backgroundColor('#F5F5F5')
    }
    .width('100%').height('100%')
    // ç»‘å®šåŠæ¨¡æ€
    .bindSheet($$this.isShowSheet, this.EditSheetBuilder(), {
      height: 280, // ç¨å¾®é«˜ä¸€ç‚¹ï¼Œé˜²æ­¢è¾“å…¥æ¡†è¢«é®æŒ¡
      dragBar: true,
      backgroundColor: Color.White,
      showClose: false
    })
  }
}
