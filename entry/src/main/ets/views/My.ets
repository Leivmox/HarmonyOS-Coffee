import { router, promptAction } from '@kit.ArkUI';
import { getStorage } from '../utils/storage';
import { findAccountInfo, ApiResponse, UserInfo } from '../api/api';

@Component
export default struct My {
  // 1. å…¨å±€ Token
  @StorageProp('token') token: string = '';

  // 2. é¡µé¢æ˜¾ç¤ºçŠ¶æ€
  @State nickName: string = 'ç‚¹å‡»ç™»å½•';
  @State desc: string = 'ç™»å½•åäº«å—æ›´å¤šæƒç›Š';
  @State menuList: string[] = [
    "ä¸ªäººèµ„æ–™",
    "æˆ‘çš„è®¢å•",
    "æˆ‘çš„æ”¶è—",
    "åœ°å€ç®¡ç†",
    "å®‰å…¨ä¸­å¿ƒ"
  ]

  // ğŸ”¥ 3. æ ¸å¿ƒæ§åˆ¶å˜é‡
  private lastRefreshTime: number = 0; // ä¸Šæ¬¡åˆ·æ–°æ—¶é—´çš„æ—¶é—´æˆ³

  // =======================================================
  // æ ¸å¿ƒé€»è¾‘ï¼šæ•°æ®åˆå§‹åŒ–
  // =======================================================
  async initData() {
    // ğŸ”¥ èŠ‚æµæ§åˆ¶ï¼šå¦‚æœè·ç¦»ä¸Šæ¬¡åˆ·æ–°ä¸è¶³ 2000ms (2ç§’)ï¼Œåˆ™å¿½ç•¥æœ¬æ¬¡è¯·æ±‚
    // è¿™èƒ½å®Œç¾è§£å†³ onPageShow å’Œ onVisibleAreaChange åŒæ—¶è§¦å‘é€ æˆçš„é‡å¤åˆ·æ–°
    let now = new Date().getTime();
    if (now - this.lastRefreshTime < 2000) {
      console.log('[MyPage] åˆ·æ–°å¤ªé¢‘ç¹ï¼Œå·²æ‹¦æˆª');
      return;
    }
    // æ›´æ–°åˆ·æ–°æ—¶é—´
    this.lastRefreshTime = now;

    console.info('[MyPage] === è§¦å‘æ•°æ®åˆ·æ–° ===');

    let finalToken = this.token;
    let context = getContext(this);

    // 1. å¦‚æœå†…å­˜æ²¡ Tokenï¼Œå°è¯•ä»æœ¬åœ°ç¼“å­˜æ¢å¤
    if (!finalToken) {
      try {
        let diskToken = await getStorage("user_token", context);
        if (diskToken) {
          finalToken = diskToken.toString();
          AppStorage.setOrCreate('token', finalToken);
        }
      } catch (e) {
        console.error('[MyPage] è¯»å–ç¼“å­˜Tokenå¤±è´¥');
      }
    }

    // 2. æ‰§è¡Œç½‘ç»œè¯·æ±‚
    await this.checkLoginAndGetInfo(finalToken);
  }

  // è·å–ç”¨æˆ·ä¿¡æ¯
  async checkLoginAndGetInfo(useToken?: string) {
    let finalToken = useToken || this.token;

    // æœªç™»å½•çŠ¶æ€
    if (!finalToken) {
      this.nickName = 'ç‚¹å‡»ç™»å½•';
      this.desc = 'ç™»å½•åäº«å—æ›´å¤šæƒç›Š';
      return;
    }

    try {
      let res = await findAccountInfo(finalToken);

      let resData: ApiResponse<UserInfo[] | UserInfo>;
      if (typeof res.result === 'string') {
        resData = JSON.parse(res.result) as ApiResponse<UserInfo[] | UserInfo>;
      } else {
        resData = res.result as ApiResponse<UserInfo[] | UserInfo>;
      }

      // çŠ¶æ€ç åˆ¤æ–­
      const codeStr = String(resData.code);
      if (['200', 'B001', 'A001', '0', '1'].includes(codeStr)) {
        let user: UserInfo | null = null;
        if (Array.isArray(resData.result)) {
          if (resData.result.length > 0) user = resData.result[0];
        } else {
          user = resData.result as UserInfo;
        }

        if (user) {
          // æ›´æ–° UI
          this.nickName = user.nickName || 'å’–å•¡æŒšå‹';
          this.desc = user.desc || 'æš‚æ— ç®€ä»‹';
        }
      } else {
        // Token è¿‡æœŸ
        if (codeStr === 'A002' || codeStr === '401') {
          this.nickName = 'ç™»å½•å·²è¿‡æœŸ';
          this.desc = 'è¯·é‡æ–°ç™»å½•';
        }
      }
    } catch (err) {
      console.error('[MyPage] æ¥å£è¯·æ±‚å¼‚å¸¸:', JSON.stringify(err));
    }
  }

  // =======================================================
  // ç”Ÿå‘½å‘¨æœŸç›‘å¬
  // =======================================================

  // 1. é¦–æ¬¡åŠ è½½
  aboutToAppear() {
    this.initData();
  }

  // 2. åªæœ‰å½“ My æ˜¯ä¸€ä¸ªå®Œæ•´çš„ @Entry é¡µé¢æ—¶ï¼Œè¿™ä¸ªæ‰ç”Ÿæ•ˆ
  // å¦‚æœ My æ˜¯ Tabs é‡Œçš„ç»„ä»¶ï¼Œè¿™ä¸ªé€šå¸¸ä¸ç”Ÿæ•ˆï¼Œä½†å†™ä¸Šä½œä¸ºä¿é™©
  onPageShow() {
    console.log('[MyPage] onPageShow è§¦å‘');
    this.initData();
  }

  @Builder
  SettingCell(title: string, showBorder: boolean) {
    Row() {
      Text(title).fontSize(16).fontColor('#333333')
      Blank()
      Text('>').fontSize(18).fontColor('#999999')
    }
    .width('100%')
    .height(55)
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      if (!this.token && title !== 'å®‰å…¨ä¸­å¿ƒ') {
        promptAction.showToast({ message: 'è¯·å…ˆç™»å½•' });
        router.pushUrl({ url: "pages/LoginPage" });
        return;
      }
      // è·¯ç”±è·³è½¬
      if (title === "æˆ‘çš„æ”¶è—") router.pushUrl({ url: "pages/MyCollect" });
      else if (title === "ä¸ªäººèµ„æ–™") router.pushUrl({ url: "pages/PersonalInfo" });
      else if (title === "æˆ‘çš„è®¢å•") router.pushUrl({ url: "pages/MyOrders" });
      else if (title === "å®‰å…¨ä¸­å¿ƒ") router.pushUrl({ url: "pages/SafetyCenter" });
      else if (title === "åœ°å€ç®¡ç†") router.pushUrl({ url: "pages/AddressManage" });
    })
    .backgroundColor(Color.Transparent)

    if (showBorder) {
      Divider().color('#F0F0F0').strokeWidth(1)
    }
  }

  build() {
    Column() {
      Stack({ alignContent: Alignment.Top }) {
        Image($r('app.media.vim_bg'))
          .width('100%')
          .height(235)
          .objectFit(ImageFit.Cover)

        Column() {
          Row() {
            Image($r('app.media.avator1'))
              .width(70)
              .height(70)
              .borderRadius(35)
              .objectFit(ImageFit.Cover)
              .margin({ right: 15 })
              .backgroundColor(Color.White)

            Column({ space: 8 }) {
              Text(this.nickName)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#3D59AB')

              Text(this.desc)
                .fontSize(13)
                .fontColor('#666666')
                .maxLines(1)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
          }
          .width('100%')
          .padding({ top: 20, bottom: 30, left: 10, right: 10 })
          .onClick(() => {
            if (!this.token) {
              router.pushUrl({ url: "pages/LoginPage" })
            } else {
              router.pushUrl({ url: "pages/PersonalInfo" })
            }
          })

          Column() {
            ForEach(this.menuList, (item: string, index: number) => {
              this.SettingCell(item, index !== this.menuList.length - 1)
            })
          }
        }
        .width('95%')
        .backgroundColor('rgba(255, 255, 255, 0.8)')
        .backdropBlur(10)
        .borderRadius(12)
        .shadow({ radius: 10, color: '#1A000000', offsetY: 5 })
        .padding({ left: 15, right: 15, bottom: 10 })
        .margin({ top: 190 })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
    // =================================================================
    // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ›´å®½æ¾çš„åˆ¤å®šæ¡ä»¶
    // =================================================================
    .onVisibleAreaChange([0.0, 0.5, 1.0], (isVisible: boolean, currentRatio: number) => {
      // è°ƒè¯•æ—¥å¿—ï¼Œè¿™è¡Œä¼šå‘Šè¯‰ä½ å½“å‰æ¯”ç‡æ˜¯å¤šå°‘
      console.log(`[MyPage] å¯è§æ€§å˜åŒ–: isVisible=${isVisible}, ratio=${currentRatio}`);

      // ğŸ”¥ ä¿®æ”¹ç‚¹ï¼šåªè¦å¯è§æ¯”ä¾‹ > 0.5 å°±åˆ·æ–°ï¼Œä¸è¦æ­»ç£• 1.0
      if (isVisible && currentRatio > 0.5) {
        this.initData();
      }
    })
  }
}
