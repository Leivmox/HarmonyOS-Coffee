// æ•°æ®æ¥å£
import { findAllShopcart, modifyShopcartCount, removeShopcart } from '../api/api';
// è´­ç‰©è½¦æ•°æ®ç±»å‹çº¦æŸ
import { shopBagItem } from '../model/model';
import { getStorage } from '../utils/storage';
import { router, promptAction } from '@kit.ArkUI';
import { debounce } from '../utils/debounce';

/**
 * @description ä¿®æ”¹è´­ç‰©è½¦å•†å“æ•°é‡(é˜²æŠ–)
 */
let f = debounce((token: string, sid: string, count: string) => {
  modifyShopcartCount(token, sid, count)
    .then(res => {
      let resData = Object(res).result as Record<string, Object>;
      console.log("ä¿®æ”¹è´­ç‰©è½¦æ•°é‡(æ¥å£ç‰ˆ) =>", JSON.stringify(resData));
    })
}, 500);

@Entry
@Component
export default struct ShopBag {
  // è´­ç‰©è½¦æ•°æ®
  @State shopbag_list: shopBagItem[] = [];
  // æ•°é‡æ•°ç»„ (ç”¨äºæœ¬åœ°å¿«é€Ÿå“åº”UI)
  @State count_arr: number[] = [];
  // Token
  @State user_token: string = "";

  // ã€å…³é”®ã€‘é€‰ä¸­çŠ¶æ€æ•°ç»„ï¼Œtrueä»£è¡¨é€‰ä¸­ï¼Œfalseä»£è¡¨æœªé€‰
  @State select_arr: boolean[] = [];
  // ã€å…³é”®ã€‘æ€»é‡‘é¢
  @State totalPrice: string = "0.00";
  // ã€å…³é”®ã€‘å…¨é€‰çŠ¶æ€
  @State isAllSelected: boolean = false;

  // é˜²æ­¢é‡å¤åˆ·æ–°
  private isRefreshing: boolean = false;

  /**
   * æ ¸å¿ƒç®—æ³•ï¼šè®¡ç®—æ€»ä»·
   * åªæœ‰å½“ select_arr[i] ä¸º true æ—¶ï¼Œæ‰è®¡ç®—è¯¥å•†å“ä»·æ ¼
   */
  calcTotal() {
    let total = 0;
    this.shopbag_list.forEach((item, index) => {
      // 1. å¿…é¡»æ˜¯é€‰ä¸­çš„
      if (this.select_arr[index]) {
        // 2. ä»·æ ¼è½¬æ•°å­—
        let price = parseFloat(item.price as string) || 0;
        // 3. æ•°é‡å–æœ¬åœ°æ•°ç»„
        let count = this.count_arr[index] || 1;

        total += price * count;
      }
    });
    // ä¿ç•™2ä½å°æ•°
    this.totalPrice = total.toFixed(2);

    // é¡ºä¾¿æ£€æŸ¥å…¨é€‰çŠ¶æ€
    if (this.select_arr.length > 0) {
      this.isAllSelected = this.select_arr.every(val => val === true);
    } else {
      this.isAllSelected = false;
    }
  }

  /**
   * åˆ é™¤åŠŸèƒ½
   */
  deleteItem(index: number) {
    if (!this.shopbag_list[index]) return;

    let sids: string[] = [];
    sids.push(this.shopbag_list[index].sid);

    removeShopcart(this.user_token, JSON.stringify(sids))
      .then(res => {
        let resBody = res.result as Record<string, Object>;
        if ((resBody['code'] as number) == 7000) {
          // åˆ é™¤æ•°æ®
          this.shopbag_list.splice(index, 1);
          this.count_arr.splice(index, 1);
          this.select_arr.splice(index, 1);
          // é‡æ–°è®¡ç®—ä»·æ ¼
          this.calcTotal();
          promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
        }
      })
  }

  @Builder
  itemEnd(idx: number, onClick: () => void) {
    Text("åˆ é™¤")
      .padding(5)
      .fontSize(16)
      .fontColor(Color.White)
      .textAlign(TextAlign.Center)
      .width(60)
      .height("100%")
      .backgroundColor(Color.Red)
      .borderRadius({ topRight: 10, bottomRight: 10 })
      .onClick(onClick)
  }

  // è·å–æ•°æ®
  private findAllShopcart() {
    if (this.user_token.length) {
      this.isRefreshing = true;
      findAllShopcart(this.user_token)
        .then(res => {
          let responseBody = res.result as Record<string, Object>;
          let listData = responseBody['result'] as shopBagItem[];

          this.shopbag_list = listData ? listData : [];

          // 1. åˆå§‹åŒ–æ•°é‡
          let count_arr: number[] = this.shopbag_list.map((v: shopBagItem) => {
            return Number(v.count);
          })
          this.count_arr = count_arr;

          // 2. åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€ (é»˜è®¤å…¨éƒ¨ä¸é€‰)
          this.select_arr = new Array(this.shopbag_list.length).fill(false);

          // 3. é‡ç½®ä»·æ ¼
          this.totalPrice = "0.00";
          this.isAllSelected = false;
        })
        .finally(() => {
          this.isRefreshing = false;
        })
    }
  }

  initData() {
    let token = getStorage("user_token", getContext(this));
    this.user_token = token ? token.toString() : "";
    if (this.user_token) {
      this.findAllShopcart();
    } else {
      this.shopbag_list = [];
      this.count_arr = [];
      this.select_arr = [];
    }
  }

  onPageShow() {
    this.initData();
  }

  build() {
    Column() {
      // ===========================
      // 1. é¡¶éƒ¨å¯¼èˆª
      // ===========================
      Row() {
        Text("< è¿”å›").fontColor($r("app.color.theme_color"))
          .onClick(() => { router.back() })
        Text("è´­ç‰©è¢‹")
        Text("åˆ·æ–°").fontColor($r("app.color.theme_color"))
          .onClick(() => {
            this.initData();
            promptAction.showToast({ message: 'å·²åˆ·æ–°' });
          })
      }
      .width("100%")
      .height(56)
      .padding({ left: 10, right: 10 })
      .justifyContent(FlexAlign.SpaceBetween)
      .backgroundColor(Color.White)

      // ===========================
      // 2. èƒŒæ™¯å›¾ç‰‡
      // ===========================
      Image($r("app.media.shopbag_bg")).width("100%")

      // ===========================
      // 3. åˆ—è¡¨åŒºåŸŸ
      // ===========================
      Scroll() {
        Column() {
          if (!this.user_token.length) {
            Row() {
              Text("è¿˜æœªç™»å½•ï¼Œå…ˆ")
              Text("ç™»å½•").fontColor($r("app.color.theme_color"))
                .onClick(() => { router.pushUrl({ url: "pages/LoginPage" }) })
            }
            .margin({top: 20})
          }
          else if (!this.shopbag_list.length) {
            Column() {
              Image($r("app.media.Null")).width(100).height(100).opacity(0.5).margin({bottom:10})
              Text("è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿ").fontColor(Color.Gray).fontSize(14)
            }
            .width('100%').justifyContent(FlexAlign.Center).alignItems(HorizontalAlign.Center)
          }
          else {
            List() {
              ForEach(this.shopbag_list, (item: shopBagItem, index: number) => {
                ListItem() {
                  Row({ space: 10 }) {
                    // --- å•é€‰æ¡† Checkbox ---
                    Checkbox({ name: 'item'+index })
                      .select(this.select_arr[index]) // ç»‘å®šé€‰ä¸­çŠ¶æ€
                      .onChange((value: boolean) => {
                        this.select_arr[index] = value; // æ›´æ–°æ•°ç»„
                        this.calcTotal(); // ğŸ”¥ğŸ”¥ğŸ”¥ é‡ç‚¹ï¼šè§¦å‘è®¡ç®—
                      })

                    // --- å•†å“å›¾ç‰‡ ---
                    Image(item.small_img)
                      .width(90).height(90)
                      .borderRadius(4).objectFit(ImageFit.Cover)
                      .backgroundColor('#f5f5f5')

                    // --- å•†å“ä¿¡æ¯ ---
                    Column() {
                      Row() {
                        Text(item.name)
                          .fontSize(14).fontWeight(FontWeight.Bold)
                          .maxLines(1).textOverflow({overflow: TextOverflow.Ellipsis})
                          .layoutWeight(1)
                      }

                      Text(item.rule)
                        .fontSize(12).fontColor('#999')
                        .margin({ top: 4, bottom: 4 })

                      Row() {
                        Text("ï¿¥" + item.price).fontSize(16).fontColor(Color.Red).fontWeight(FontWeight.Bold)

                        // --- åŠ å‡æŒ‰é’® ---
                        Row({ space: 0 }) {
                          // å‡å·
                          Button("-")
                            .width(26).height(26).padding(0)
                            .backgroundColor('#f5f5f5').fontColor('#333')
                            .type(ButtonType.Normal).borderRadius({topLeft: 13, bottomLeft: 13})
                            .onClick(() => {
                              if (this.count_arr[index] > 1) {
                                this.count_arr[index]--;
                                f(this.user_token, item.sid, String(this.count_arr[index]));
                                this.calcTotal(); // ğŸ”¥ğŸ”¥ğŸ”¥ é‡ç‚¹ï¼šè§¦å‘è®¡ç®—
                              } else {
                                this.deleteItem(index);
                              }
                            })

                          // æ•°é‡
                          Text(String(this.count_arr[index]))
                            .width(36).height(26)
                            .textAlign(TextAlign.Center).fontSize(13)
                            .backgroundColor('#f5f5f5')

                          // åŠ å·
                          Button("+")
                            .width(26).height(26).padding(0)
                            .backgroundColor('#f5f5f5').fontColor('#333')
                            .type(ButtonType.Normal).borderRadius({topRight: 13, bottomRight: 13})
                            .onClick(() => {
                              this.count_arr[index]++;
                              f(this.user_token, item.sid, String(this.count_arr[index]));
                              this.calcTotal(); // ğŸ”¥ğŸ”¥ğŸ”¥ é‡ç‚¹ï¼šè§¦å‘è®¡ç®—
                            })
                        }
                      }
                      .width("100%").justifyContent(FlexAlign.SpaceBetween)
                    }
                    .layoutWeight(1).alignItems(HorizontalAlign.Start).height(90).justifyContent(FlexAlign.SpaceBetween)
                  }
                  .padding(10).backgroundColor(Color.White).margin({bottom: 10}).borderRadius(8)
                }
                .swipeAction({
                  end: this.itemEnd(index, () => { this.deleteItem(index) }),
                  edgeEffect: SwipeEdgeEffect.Spring
                })
              })
            }
          }
        }
        .constraintSize({ minHeight: '100%' })
        .justifyContent(this.shopbag_list.length === 0 ? FlexAlign.Center : FlexAlign.Start)
        .padding({left: 10, right: 10, top: 10})
      }
      .layoutWeight(1)
      .align(Alignment.Top)
      .backgroundColor('#f5f5f5')

      // ===========================
      // 4. åº•éƒ¨ç»“ç®—æ 
      // ===========================
      Row() {
        Row() {
          // --- å…¨é€‰ Checkbox ---
          Checkbox({ name: 'all' })
            .select(this.isAllSelected)
            .onChange((value: boolean) => {
              this.isAllSelected = value;
              // æ›´æ–°æ‰€æœ‰å•ç‹¬çš„é€‰ä¸­çŠ¶æ€
              for (let i = 0; i < this.select_arr.length; i++) {
                this.select_arr[i] = value;
              }
              this.calcTotal(); // ğŸ”¥ğŸ”¥ğŸ”¥ é‡ç‚¹ï¼šè§¦å‘è®¡ç®—
            })
          Text("å…¨é€‰").fontSize(14).fontColor('#333')
        }

        Row({ space: 10 }) {
          Row() {
            Text("åˆè®¡: ").fontSize(14)
            Text("ï¿¥" + this.totalPrice).fontSize(18).fontColor(Color.Red).fontWeight(FontWeight.Bold)
          }

          Button(`æäº¤è®¢å•`)
            .height(36)
            .linearGradient({
              angle: 90,
              colors: [[0xfe5d33, 0.2], [0xee0d26, 1.0]]
            })
            .onClick(() => {
              // 1. è¿‡æ»¤å‡ºé€‰ä¸­çš„å•†å“
              let selectedItems: shopBagItem[] = [];
              let finalTotal = 0;

              this.shopbag_list.forEach((item, i) => {
                if (this.select_arr[i]) {
                  let currentItem = item;
                  currentItem.count = this.count_arr[i];
                  selectedItems.push(currentItem);
                  finalTotal += Number(item.price) * this.count_arr[i];
                }
              });

              if (selectedItems.length === 0) {
                promptAction.showToast({ message: 'è¯·å…ˆé€‰æ‹©è¦è´­ä¹°çš„å•†å“' });
                return;
              }

              // 2. è·³è½¬åˆ°ç»“ç®—é¡µ
              router.pushUrl({
                url: "pages/OrderSettle",
                params: {
                  list: selectedItems,
                  total: finalTotal.toFixed(2)
                }
              })
            })
        }
      }
      .width('100%')
      .padding({ left: 15, right: 15, top: 10, bottom: 10 })
      .backgroundColor(Color.White)
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .height("100%")
    .backgroundColor('#f5f5f5')
    .onVisibleAreaChange([0.0, 1.0], (isVisible: boolean, currentRatio: number) => {
      if (isVisible && currentRatio >= 1.0 && !this.isRefreshing) {
        this.initData();
      }
    })
  }
}
